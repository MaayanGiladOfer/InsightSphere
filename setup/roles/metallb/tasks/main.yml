---
- include_vars: ../../../values.yml

- name: Retrieve the IPv4 Range from the Kind Cluster Network
  ansible.builtin.shell: >
    docker network inspect -f '{{ "{{.IPAM.Config}}" | quote }}' kind
    | grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}'
    | head -n 1
  register: ip_range
  
- name: Generate the IPv4 Range for MetalLB IP Pool
  ansible.builtin.shell: echo "{{ ip_range.stdout }}.120-{{ ip_range.stdout }}.129"
  register: ip_pool_range

- name: Apply MetalLB Base Configuration
  kubernetes.core.k8s:
    state: present
    namespace: "{{ metallb_namespace }}"
    src: metallb.yaml

- name: Wait for MetalLB Components to be Ready
  shell: "kubectl get pods -o json -n {{ metallb_namespace }}"
  register: kubectl_get_pods
  until: kubectl_get_pods.stdout|from_json|json_query('items[*].status.phase')|unique == ["Running"]

- name: Apply MetalLB L2 Advertisement Configuration
  kubernetes.core.k8s:
    state: present
    namespace: "{{ metallb_namespace }}"
    src: l2advertisement.yaml

- name: Apply MetalLB IP Pool Configuration
  kubernetes.core.k8s:
    state: present
    namespace: "{{ metallb_namespace }}"
    definition: "{{ lookup('template', 'templates/ip-pool.yaml.j2') | from_yaml }}"

